<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>舆情分析看板 (联动分析版)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-wordcloud@2.1.0/dist/echarts-wordcloud.min.js"></script>
    <style>
        :root {
            --primary-color: #5470C6; --background-color: #f5f7fa; --card-background: #ffffff;
            --text-color: #333; --border-color: #e0e0e0; --shadow: 0 8px 24px rgba(0,0,0,0.05);
            --positive-color: #67C23A; --negative-color: #F56C6C;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--background-color); color: var(--text-color); margin: 0; padding: 20px; }
        .container { max-width: 1800px; margin: 0 auto; }
        .card { background: var(--card-background); padding: 25px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 25px; }
        h1, h3 { text-align: center; color: #2c3e50; margin-top: 0; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border-color); box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        button:hover { background: #405aad; box-shadow: 0 4px 15px rgba(84, 112, 198, 0.3); transform: translateY(-2px); }
        .loader { display: none; margin: 20px auto; border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid var(--primary-color); width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .chart-card { background: var(--card-background); padding: 20px; border-radius: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .chart-box { width: 100%; height: 400px; flex-grow: 1; }
        pre { background-color: #e9ecef; padding: 15px; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>

    <div class="container">
        <div class="card">
            <h1>舆情分析看板 (联动分析版)</h1>
            <div class="form-grid">
                <!-- 表单部分与之前版本相同 -->
                <div class="form-group"><label for="language">语言</label><select id="language"><option value="zh" selected>中文</option><option value="en">英文</option></select></div>
                <div class="form-group"><label for="model-choice">情感模型</label><select id="model-choice"></select></div>
                <div class="form-group"><label for="topic">话题</label><input type="text" id="topic" value="迪士尼"></div>
                <div class="form-group"><label for="start-date">开始日期</label><input type="date" id="start-date" value="2024-07-01"></div>
                <div class="form-group"><label for="end-date">结束日期</label><input type="date" id="end-date" value="2024-08-01"></div>
                <div class="form-group"><label for="keyword-method">关键词算法</label><select id="keyword-method"><option value="hybrid_ensemble" selected>混合集成 (Best)</option><option value="pos_guided_keybert">词性引导</option><option value="hybrid">混合模式</option><option value="keybert">KeyBERT</option><option value="textrank">TextRank</option></select></div>
            </div>
            <div style="margin-top: 20px;"><button onclick="runAnalysis()">开始分析</button><div class="loader" id="loader"></div></div>
        </div>

        <div id="result-container" style="display:none;">
            <div class="charts-container">
                <div class="chart-card"><div class="chart-box" id="sentiment-pie-chart"></div></div>
                <div class="chart-card"><div class="chart-box" id="sentiment-trend-chart"></div></div>
                <div class="chart-card"><div class="chart-box" id="hot-topics-chart"></div></div>
            </div>
            <!-- 【新增】联动分析词云图区域 -->
            <div class="charts-container" style="margin-top: 25px;">
                <div class="chart-card"><h3>优点关键词 (Positive)</h3><div class="chart-box" id="positive-wordcloud-chart"></div></div>
                <div class="chart-card"><h3>缺点关键词 (Negative)</h3><div class="chart-box" id="negative-wordcloud-chart"></div></div>
                <div class="chart-card"><h3>综合关键词 (Overall)</h3><div class="chart-box" id="overall-wordcloud-chart"></div></div>
            </div>
            <div class="card" style="margin-top: 25px;">
                <h2>原始JSON响应 (用于调试)</h2><pre id="raw-json"></pre>
            </div>
        </div>
    </div>

    <script>
        // 初始化所有ECharts实例
        const pieChart = echarts.init(document.getElementById('sentiment-pie-chart'));
        const sentimentTrendChart = echarts.init(document.getElementById('sentiment-trend-chart'));
        const hotTopicsChart = echarts.init(document.getElementById('hot-topics-chart'));
        const positiveWordcloud = echarts.init(document.getElementById('positive-wordcloud-chart'));
        const negativeWordcloud = echarts.init(document.getElementById('negative-wordcloud-chart'));
        const overallWordcloud = echarts.init(document.getElementById('overall-wordcloud-chart'));

        const allCharts = [pieChart, sentimentTrendChart, hotTopicsChart, positiveWordcloud, negativeWordcloud, overallWordcloud];
        window.onresize = () => allCharts.forEach(chart => chart.resize());

        // 动态模型选择逻辑 (保持不变)
        const languageSelect = document.getElementById('language');
        const modelSelect = document.getElementById('model-choice');
        const modelOptions = { 'zh': [{ value: 'bert', text: 'BERT (中文)' }, { value: 'snownlp', text: 'SnowNLP' }], 'en': [{ value: 'bert', text: 'BERT (English)' }] };
        function updateModelOptions() { const lang = languageSelect.value; modelSelect.innerHTML = ''; modelOptions[lang].forEach(opt => { const option = document.createElement('option'); option.value = opt.value; option.textContent = opt.text; modelSelect.appendChild(option); }); }
        languageSelect.addEventListener('change', updateModelOptions);
        updateModelOptions();

        async function runAnalysis() {
            // ... (获取表单数据和显示加载动画的逻辑保持不变) ...
            const resultContainer = document.getElementById('result-container');
            const loader = document.getElementById('loader');
            const requestPayload = { language: languageSelect.value, topic: document.getElementById('topic').value, start_date: document.getElementById('start-date').value, end_date: document.getElementById('end-date').value, model_choice: modelSelect.value, keyword_method: document.getElementById('keyword-method').value, top_k_keywords: 50 };
            if (!requestPayload.topic.trim() || !requestPayload.start_date || !requestPayload.end_date) { alert("请填写所有必填字段！"); return; }
            loader.style.display = 'block';
            resultContainer.style.display = 'none';
            allCharts.forEach(chart => chart.showLoading());

            try {
                const response = await fetch('http://127.0.0.1:8001/analyze', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestPayload) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`HTTP 错误! 状态: ${response.status} - ${errorData.detail || '未知错误'}`); }
                const data = await response.json();
                document.getElementById('raw-json').textContent = JSON.stringify(data, null, 2);
                resultContainer.style.display = 'block';

                // --- 【核心修改】调用新的图表渲染函数 ---
                updateSentimentPie(data.sentiment_pie_chart, data.topic_info.total_texts);
                updateSentimentTrendChart(data.sentiment_trend_chart);
                updateHotTopicsChart(data.hot_topics_trend_chart);
                // 渲染三个词云图
                updateWordCloud(overallWordcloud, "综合关键词", data.overall_word_cloud);
                updateWordCloud(positiveWordcloud, "优点关键词", data.positive_keywords, ['#67C23A', '#95d475']);
                updateWordCloud(negativeWordcloud, "缺点关键词", data.negative_keywords, ['#F56C6C', '#f89898']);

            } catch (error) {
                console.error("请求API时发生错误:", error);
                alert("分析失败，请检查后端服务是否正常运行，或查看浏览器控制台 (F12) 获取详情。\n错误: " + error.message);
            } finally {
                loader.style.display = 'none';
                allCharts.forEach(chart => chart.hideLoading());
            }
        }

        // --- 图表渲染函数 ---
        function updateSentimentPie(pieData, total) {
            const option = { title: { text: '情感分布', subtext: `总计: ${total} 条`, left: 'center' }, tooltip: { trigger: 'item' }, legend: { orient: 'vertical', left: 'left' }, series: [{ name: '情感占比', type: 'pie', radius: ['40%', '70%'], data: [{ value: pieData.positive, name: '正面', itemStyle: { color: '#67C23A' } }, { value: pieData.neutral, name: '中性', itemStyle: { color: '#E6A23C' } }, { value: pieData.negative, name: '负面', itemStyle: { color: '#F56C6C' } }] }] };
            pieChart.setOption(option, true);
        }

        function updateWordCloud(chartInstance, title, keywordsData, colorRange) {
            const option = {
                title: { text: title, left: 'center', show: false }, // 标题由卡片提供
                tooltip: { show: true, formatter: params => `${params.name} (权重: ${params.value.toFixed(4)})` },
                series: [{
                    type: 'wordCloud', shape: 'circle', sizeRange: [15, 80], rotationRange: [-60, 60],
                    textStyle: {
                        color: colorRange ? () => colorRange[Math.floor(Math.random() * colorRange.length)] : () => `rgb(${Math.floor(Math.random() * 180)}, ${Math.floor(Math.random() * 180)}, ${Math.floor(Math.random() * 180)})`
                    },
                    data: keywordsData.map(item => ({ name: item.word, value: item.weight }))
                }]
            };
            chartInstance.setOption(option, true);
        }

        function updateSentimentTrendChart(trendData) {
            const option = { title: { text: '话题情绪趋势', left: 'center' }, tooltip: { trigger: 'axis' }, legend: { top: 'bottom' }, grid: { left: '3%', right: '4%', bottom: '10%', containLabel: true }, xAxis: { type: 'category', boundaryGap: false, data: trendData.map(item => item.date) }, yAxis: { type: 'value' }, series: [{ name: '正面', type: 'line', smooth: true, data: trendData.map(item => item.positive_count), itemStyle: { color: '#67C23A' } }, { name: '中性', type: 'line', smooth: true, data: trendData.map(item => item.neutral_count), itemStyle: { color: '#E6A23C' } }, { name: '负面', type: 'line', smooth: true, data: trendData.map(item => item.negative_count), itemStyle: { color: '#F56C6C' } }] };
            sentimentTrendChart.setOption(option, true);
        }

        function updateHotTopicsChart(chartData) {
            const topics = [...new Set(chartData.map(item => item.topic))];
            const dates = [...new Set(chartData.map(item => item.date))].sort();
            const series = topics.map(topic => ({ name: topic, type: 'line', smooth: true, data: dates.map(date => (chartData.find(d => d.date === date && d.topic === topic) || {}).hotness || 0) }));
            const option = { title: { text: '全时段热点趋势', left: 'center' }, tooltip: { trigger: 'axis' }, legend: { top: 'bottom', type: 'scroll' }, grid: { left: '3%', right: '4%', bottom: '15%', containLabel: true }, xAxis: { type: 'category', boundaryGap: false, data: dates }, yAxis: { type: 'value' }, dataZoom: [{ type: 'inside' }, { type: 'slider' }], series: series };
            hotTopicsChart.setOption(option, true);
        }
    </script>
</body>
</html>